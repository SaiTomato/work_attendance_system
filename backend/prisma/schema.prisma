generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- 列挙型定義 ---

enum UserRole {
  admin
  manager
  hr
  viewer
  terminal
}

// 性別定義
enum Gender {
  MALE
  FEMALE
  OTHER
}

// 役職定義
enum Position {
  STAFF          // 一般社員
  SUB_MANAGER    // 次長
  MANAGER        // 部長
  GENERAL_AFFAIRS // 総務
  CEO            // 社長
}

// 従業員ライフサイクルステータス
enum EmployeeStatus {
  PROSPECTIVE // 内定
  ACTIVE      // 在職
  RESIGNED    // 退職
}

// 勤務形態ステータス (長期的な状態)
enum DutyStatus {
  NORMAL        // 通常勤務
  PAID_LEAVE    // 有給休暇
  UNPAID_LEAVE  // 無給休暇
}

// 勤務場所定義
enum WorkLocation {
  OFFICE
  REMOTE
  WORKSITE    // 現場
}

// --- コアモデル ---

model Department {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  description String?
  
  employees   Employee[]
  users       User[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
}

// 【従業員情報】
model Employee {
  id              String         @id @default(uuid())
  employeeId      String         @unique // 従業員ID
  name            String
  gender          Gender         // 性別
  age             Int            // 年齢
  phone           String         // 電話番号
  email           String         // メールアドレス
  
  departmentId    String
  department      Department     @relation(fields: [departmentId], references: [id])
  
  position        Position       @default(STAFF)
  status          EmployeeStatus @default(PROSPECTIVE)
  
  // 勤務形態と場所
  dutyStatus      DutyStatus     @default(NORMAL)
  dutyStatusEndDate DateTime?    // 休暇終了日
  workLocation    WorkLocation   @default(OFFICE)
  
  hireDate        DateTime?
  
  attendance      Attendance[]
  leaveRequests   LeaveRequest[]
  user            User?          // 逆参照

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?
}

// 【ログイン情報】
model User {
  id           String     @id @default(uuid())
  username     String     @unique // ユーザー名 (ログインID)
  password     String
  role         UserRole   @default(viewer)
  
  // 管理者(admin)や端末(terminal)の場合、employeeIdはnull
  employeeId   String?    @unique
  employee     Employee?  @relation(fields: [employeeId], references: [employeeId])
  
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  
  refreshTokens RefreshToken[]

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

// 【勤怠記録】 (イベントログ形式)
model Attendance {
  id           String   @id @default(uuid())
  employeeId   String
  status       String   // "出勤-通常", "出勤-遅刻", "退勤-通常", "異常-欠勤", "外出-現場", "休暇-有給" などのラベル
  recorder     String   // 記録者 (ユーザー名、または "SYSTEM" / "QR_SCANNER")
  recordTime   DateTime @default(now()) // 記録日時
  reason       String?  // 修正理由 (管理者による修正時に記入)

  employee     Employee @relation(fields: [employeeId], references: [employeeId])

  @@index([employeeId, recordTime])
}

// 【リフレッシュトークン】
model RefreshToken {
  id        String   @id @default(uuid())
  tokenHash String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime @default(now())
}

// 基本ルール設定 (システム全体の時間基準)
model AttendanceRule {
  id              String   @id @default(uuid())
  name            String
  standardCheckIn String   // 例: "09:00"
  standardCheckOut String  // 例: "18:00"
  windowStart     String   @default("07:00") // 打刻可能開始時間
  windowEnd       String   @default("14:00") // 打刻可能終了時間 (遅延判定等の境界)
  autoCheckoutTime String  @default("20:00") // 自動退勤判定時間
  isDefault       Boolean  @default(false)
}

// --- 監査ログ ---
model AuditLog {
  id          String   @id @default(uuid())
  targetId    String   // 対象ID (従業員IDまたは勤怠記録ID)
  action      String   // "CREATE", "UPDATE", "DELETE", "MANUAL_FIX" 等
  before      Json?    // 変更前データ
  after       Json?    // 変更後データ
  operatedBy  String   // 操作者 (ユーザー名)
  operatedAt  DateTime @default(now())
  reason      String?  // 理由

  @@index([targetId])
}

// --- 休暇申請と承認 ---

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum LeaveType {
  PAID    // 有給
  UNPAID  // 無給
}

model LeaveRequest {
  id               String         @id @default(uuid())
  employeeId       String
  employee         Employee       @relation(fields: [employeeId], references: [employeeId])
  
  type             LeaveType      @default(PAID)
  startDate        DateTime
  endDate          DateTime
  reason           String?
  
  status           ApprovalStatus @default(PENDING)
  approvedBy       String?        // 承認者
  isReadByEmployee Boolean        @default(false)
  
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
}

model Holiday {
  id          String   @id @default(uuid())
  date        String   @unique // "YYYY-MM-DD"
  name        String
  isWorkday   Boolean  @default(false)
  createdAt   DateTime @default(now())
}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- 枚举定义 ---

enum UserRole {
  admin
  manager
  hr
  viewer
  terminal
}

// 性别定义
enum Gender {
  MALE
  FEMALE
  OTHER
}

// 职位定义
enum Position {
  STAFF          // 员工
  SUB_MANAGER    // 次长
  MANAGER        // 部长
  GENERAL_AFFAIRS // 总务
  CEO            // 社长
}

// 员工生命周期状态
enum EmployeeStatus {
  PROSPECTIVE // 内定
  ACTIVE      // 在职
  RESIGNED    // 离职
}

// 出勤模式状态 (长期状态)
enum DutyStatus {
  NORMAL        // 正常上班
  PAID_LEAVE    // 有休
  UNPAID_LEAVE  // 无休
}

// 工作地点定义
enum WorkLocation {
  OFFICE
  REMOTE
  WORKSITE    // 现场
}

// --- 核心模型 ---

model Department {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  description String?
  
  employees   Employee[]
  users       User[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
}

// 【员工情报】
model Employee {
  id              String         @id @default(uuid())
  employeeId      String         @unique // 员工ID
  name            String
  gender          Gender         // 性别 (枚举)
  age             Int            // 年龄
  phone           String         // 电话
  email           String         // email
  
  departmentId    String
  department      Department     @relation(fields: [departmentId], references: [id])
  
  position        Position       @default(STAFF)
  status          EmployeeStatus @default(PROSPECTIVE)
  
  // 出勤模式与地点
  dutyStatus      DutyStatus     @default(NORMAL)
  dutyStatusEndDate DateTime?    // 假期结束时间
  workLocation    WorkLocation   @default(OFFICE)
  
  hireDate        DateTime?
  
  attendance      Attendance[]
  leaveRequests   LeaveRequest[]
  user            User?          // 反向关联

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?
}

// 【登入情报】
model User {
  id           String     @id @default(uuid())
  username     String     @unique // 用户ID
  password     String
  role         UserRole   @default(viewer)
  
  // 对于 admin 和 terminal，employeeId 为 null
  employeeId   String?    @unique
  employee     Employee?  @relation(fields: [employeeId], references: [employeeId])
  
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  
  refreshTokens RefreshToken[]

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

// 【出勤记录】 (流水账模式)
model Attendance {
  id           String   @id @default(uuid())
  employeeId   String
  status       String   // "出勤-正常", "出勤-迟到", "退勤-正常", "异常-缺勤", "公司外-现场", "休假-有休" 等
  recorder     String   // 记录者 (username 或 "SYSTEM" 或 "QR_SCANNER")
  recordTime   DateTime @default(now()) // 记录时间 (系统即时生成)
  reason       String?  // 记录理由 (管理员修改时填写)

  employee     Employee @relation(fields: [employeeId], references: [employeeId])

  @@index([employeeId, recordTime])
}

// 【RefreshToken】
model RefreshToken {
  id        String   @id @default(uuid())
  tokenHash String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime @default(now())
}

// 基础规则配置 (保留作为系统全局时间常数)
model AttendanceRule {
  id              String   @id @default(uuid())
  name            String
  standardCheckIn String   // "09:00"
  standardCheckOut String  // "18:00"
  windowStart     String   @default("07:00") // 可打卡开始时间
  windowEnd       String   @default("14:00") // 可打卡结束时间
  autoCheckoutTime String  @default("20:00") // 自动判定退勤时间
  isDefault       Boolean  @default(false)
}
// --- 审计日志 ---
model AuditLog {
  id          String   @id @default(uuid())
  targetId    String   // 目标 ID (员工 id 或 出勤记录 id)
  action      String   // "CREATE", "UPDATE", "DELETE", "PUNCH"
  before      Json?    // 变更前数据
  after       Json?    // 变更后数据
  operatedBy  String   // 操作人 (username)
  operatedAt  DateTime @default(now())
  reason      String?  // 理由

  @@index([targetId])
}

// --- 审批与假期 ---

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum LeaveType {
  PAID    // 有休
  UNPAID  // 无休
}

model LeaveRequest {
  id               String         @id @default(uuid())
  employeeId       String
  employee         Employee       @relation(fields: [employeeId], references: [employeeId])
  
  type             LeaveType      @default(PAID)
  startDate        DateTime
  endDate          DateTime
  reason           String?
  
  status           ApprovalStatus @default(PENDING)
  approvedBy       String?        // 审批人 username
  isReadByEmployee Boolean        @default(false)
  
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
}

model Holiday {
  id          String   @id @default(uuid())
  date        String   @unique // "YYYY-MM-DD"
  name        String
  isWorkday   Boolean  @default(false)
  createdAt   DateTime @default(now())
}
